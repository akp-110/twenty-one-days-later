<div class="content-wrapper">
  <div class="main-header-container">
    <div class="header-flex-container">
      <div class="group-title">
        <h1><%= @group.name.titleize %></h1>
      </div>
      <div class="progress-indicators">
        <%= image_tag "user.png", alt: "User" %> Ã— 4
      </div>
    </div>

    <% if (goal = @group.goals.first) %>
      <%= link_to edit_group_goal_path(goal.group, goal), class: "edit-icon-link" do %>
        <i class="fas fa-edit"></i>
      <% end %>
    <% end %>

    <div class="goal-info">
      <div class="info-box">
        <span>Start date: <%= goal&.start_date&.strftime("%m/%d/%Y") || "Not set" %></span>
      </div>
      <div class="info-box">
        <span>Challenge: <%= goal&.name || "No goal set" %></span>
      </div>
    </div>

    <% if goal&.start_date.present? %>
      <% days_until_start = (goal.start_date - Date.today).to_i %>
      <% if days_until_start.positive? %>
        <p class="countdown-message" id="pre-start-countdown-<%= goal.id %>" data-start-date="<%= goal.start_date %>">
          ğŸš€ <strong><%= days_until_start %> days until the goal begins!</strong>
        </p>
      <% end %>
    <% end %>
  </div>

  <div class="group-show">
    <% if @group.goals.empty? %>
      <div class="form-actions">
        <%= link_to "Set a Goal for This Group", new_group_goal_path(@group), class: "btn btn-success" %>
      </div>
    <% else %>
      <div class="goals-section" style="display: none;">
        <h3>Goals:</h3>
        <% @group.goals.each do |goal| %>
          <div class="goal-container">
            <p><strong><%= goal.name %></strong></p>
            <%= link_to "Edit", edit_group_goal_path(goal.group, goal), class: "btn" %>
            <p><strong>Start Date:</strong> <%= goal.start_date&.strftime("%d %b %Y") || "Not set" %></p>

            <% if goal.start_date.present? %>
              <% days_until_start = (goal.start_date - Date.today).to_i %>
              <% days_left = (goal.end_date - Date.today).to_i %>

              <% if days_until_start.positive? %>
                <p id="pre-start-countdown-<%= goal.id %>" data-start-date="<%= goal.start_date %>">
                  ğŸš€ <strong><%= days_until_start %> days until <%= goal.name %> begins!</strong>
                </p>
              <% elsif days_left.positive? %>
                <p id="countdown-<%= goal.id %>" data-end-date="<%= goal.end_date %>">
                  â³ <strong><%= days_left %> days left!</strong>
                </p>
              <% else %>
                <p>âœ… <strong>Goal deadline reached!</strong></p>
              <% end %>
            <% else %>
              <p><em>Start date not set for this goal.</em></p>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>

    <div class="member-progress-header"><h2>Member Progress</h2></div>

    <div class="members-container">
      <% @group.members.each do |member| %>
        <div class="member-row">
          <div class="member-info">
            <div class="img-box">
              <% if member.photo.attached? %>
                <%= cl_image_tag member.photo.key, class: "avatar-square", alt: "avatar", height: 100, width: 100, crop: :fill %>
              <% else %>
                <%= image_tag "default-avatar.svg", class: "avatar-square", alt: "avatar", height: 100, width: 100 %>
              <% end %>
            </div>
            <h4><%= member.first_name %></h4>
          </div>
            <div class="member-card">
            <% if @goal %>
            <div class="progress-stars"
                data-controller="progress-stars"
                data-group-id="<%= @group.id %>"
                data-goal-id="<%= @goal.id %>"
                data-progress-stars-user-id="<%= member.id %>"
                data-progress-stars-current-user-id="<%= current_user.id %>">

              <div class="stars-row">
                <% 11.times do |i| %>
                  <span class="star"
                        data-progress-stars-target="star"
                        data-day="<%= i %>">
                    <i class="fa-regular fa-star"></i>
                  </span>
                <% end %>
              </div>

              <div class="stars-row">
                <% 10.times do |i| %>
                  <span class="star"
                        data-progress-stars-target="star"
                        data-day="<%= i + 11 %>">
                    <i class="fa-regular fa-star"></i>
                  </span>
                <% end %>
                <% completed_count = (@completed_dates[member.id] || []).size %>
                <i id="checkmark-21-<%= member.id %>" class="fas fa-check-circle" style="color: <%= (@completed_dates[member.id]&.length || 0) >= 21 ? 'green' : 'gray' %>; font-size: 32px; vertical-align: middle; margin-left: 8px;"></i>

                <button type="button" class="comment-btn" data-bs-toggle="modal" data-bs-target="#exampleModal">
                  <i class="fas fa-comment-alt"></i>
                  <% end %>
                </button>
              </div>
            </div>
          </div>


        </div>
      <% end %>
    </div>

    <div class="member-progress-header"><h2>Comments</h2></div>
    <div class="members-container"><%= render "comments/comments_list", comments: @comments %></div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <%= simple_form_for [@group, @comment] do |f| %>
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Comment</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <%= f.input :message, label_html: { class: "d-none" }, placeholder: "Comment here...", class: "review" %>
        </div>
        <div class="modal-footer">
          <%= f.button :submit, value: "Add a comment", class: "btn" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  document.addEventListener("turbo:load", function () {
    function updateCountdown(id, endDateStr) {
      const el = document.getElementById(id);
      if (!el) return;
      const endDate = new Date(endDateStr).getTime();
      const now = new Date().getTime();
      const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
      el.innerText = daysLeft > 0 ? `â³ ${daysLeft} days left!` : "âœ… Goal deadline reached!";
    }

    document.querySelectorAll("[id^='pre-start-countdown-']").forEach(el => {
      const startDate = new Date(el.dataset.startDate).getTime();
      const goalId = el.id.replace("pre-start-countdown-", "");
      const countdownEl = document.getElementById(`countdown-${goalId}`);

      setInterval(() => {
        const now = new Date().getTime();
        const daysUntil = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
        el.innerText = `ğŸš€ ${daysUntil} days until the goal begins!`;
        if (daysUntil <= 0 && countdownEl) {
          el.style.display = "none";
          countdownEl.style.display = "block";
          updateCountdown(countdownEl.id, countdownEl.dataset.endDate);
          setInterval(() => updateCountdown(countdownEl.id, countdownEl.dataset.endDate), 86400000);
        }
      }, 1000);
    });

    document.querySelectorAll("[id^='countdown-']").forEach(el => {
      updateCountdown(el.id, el.dataset.endDate);
      setInterval(() => updateCountdown(el.id, el.dataset.endDate), 86400000);
    });
  });
</script>
